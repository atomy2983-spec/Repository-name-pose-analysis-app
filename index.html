<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ê·¼ê³¨ê²©ê³„ ë¶„ì„">
    <meta name="theme-color" content="#3b82f6">
    
    <title>ê·¼ê³¨ê²©ê³„ ìœ„í—˜ë„ ë¶„ì„ - PWA</title>
    
    <link rel="manifest" href="manifest.json">
    
    <!-- iOS ì•„ì´ì½˜ -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%233b82f6' width='100' height='100'/%3E%3Ctext x='50' y='60' font-size='50' text-anchor='middle' fill='white'%3EğŸ—ï¸%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@2.1.0"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            overflow-x: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
        }
        
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 15px;
            color: #60a5fa;
            font-size: 18px;
            line-height: 1.3;
        }
        
        .controls {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        button, .file-label {
            padding: 10px 16px;
            background: #3b82f6;
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            touch-action: manipulation;
        }
        
        button:active, .file-label:active {
            transform: scale(0.95);
            background: #2563eb;
        }
        
        button:disabled {
            background: #475569;
            opacity: 0.6;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .file-label {
            background: #8b5cf6;
            display: inline-block;
        }
        
        .status {
            padding: 10px;
            background: #1e293b;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 12px;
            font-size: 13px;
            border: 1px solid #334155;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .video-container {
            position: relative;
            background: #1e293b;
            border-radius: 12px;
            overflow: hidden;
            min-height: 300px;
        }
        
        #canvas {
            width: 100%;
            display: block;
            border-radius: 12px;
        }
        
        video {
            display: none;
        }
        
        .info-panel {
            background: #1e293b;
            border-radius: 12px;
            padding: 15px;
        }
        
        .info-panel h2 {
            margin-bottom: 12px;
            color: #60a5fa;
            font-size: 16px;
        }
        
        .metric {
            margin-bottom: 15px;
            padding: 12px;
            background: #0f172a;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        
        .metric-label {
            font-size: 10px;
            color: #94a3b8;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .metric-value {
            font-size: 24px;
            font-weight: bold;
        }
        
        .metric-desc {
            font-size: 11px;
            color: #cbd5e1;
            margin-top: 4px;
        }
        
        .risk-low { color: #10b981; border-left-color: #10b981; }
        .risk-medium { color: #f59e0b; border-left-color: #f59e0b; }
        .risk-high { color: #ef4444; border-left-color: #ef4444; }
        
        .angle-list {
            display: grid;
            gap: 8px;
        }
        
        .angle-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #0f172a;
            border-radius: 6px;
            font-size: 13px;
        }
        
        .angle-value {
            font-weight: bold;
        }

        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: #3b82f6;
            padding: 15px;
            border-radius: 12px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .install-prompt.show {
            display: flex;
        }

        .install-prompt button {
            background: white;
            color: #3b82f6;
            padding: 8px 16px;
            white-space: nowrap;
        }

        .install-prompt .close {
            background: transparent;
            color: white;
            padding: 0;
            width: 30px;
            height: 30px;
            font-size: 20px;
        }

        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
            }
            
            .video-container {
                flex: 1;
            }
            
            .info-panel {
                width: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ï¸ ê·¼ê³¨ê²©ê³„ ìœ„í—˜ë„ ë¶„ì„<br><small style="font-size: 12px; color: #94a3b8;">ì‹¤ì‹œê°„ AI í¬ì¦ˆ ë¶„ì„</small></h1>
        
        <div class="controls">
            <button id="startWebcam">ğŸ“¹ ì¹´ë©”ë¼</button>
            <button id="stopWebcam" disabled>â¹ï¸ ì •ì§€</button>
            <label for="videoFile" class="file-label">ğŸ“ ì˜ìƒ</label>
            <input type="file" id="videoFile" accept="video/*">
        </div>
        
        <div class="status" id="status">
            ğŸ”„ AI ëª¨ë¸ ë¡œë”© ì¤‘...
        </div>
        
        <div class="main-content">
            <div class="video-container">
                <canvas id="canvas"></canvas>
                <video id="video" playsinline muted></video>
            </div>
            
            <div class="info-panel">
                <h2>ğŸ“Š ì‹¤ì‹œê°„ ë¶„ì„</h2>
                
                <div id="overallRisk" class="metric risk-low">
                    <div class="metric-label">ì¢…í•© ìœ„í—˜ë„</div>
                    <div class="metric-value">ëŒ€ê¸°ì¤‘</div>
                    <div class="metric-desc">í¬ì¦ˆ ê°ì§€ ëŒ€ê¸°ì¤‘...</div>
                </div>
                
                <div class="angle-list" id="angleList">
                    <div class="angle-item">
                        <span>í—ˆë¦¬ êµ½í˜</span>
                        <span class="angle-value">-Â°</span>
                    </div>
                    <div class="angle-item">
                        <span>ëª© ê¸°ìš¸ê¸°</span>
                        <span class="angle-value">-Â°</span>
                    </div>
                    <div class="angle-item">
                        <span>ì–´ê¹¨ (ì¢Œ)</span>
                        <span class="angle-value">-Â°</span>
                    </div>
                    <div class="angle-item">
                        <span>ì–´ê¹¨ (ìš°)</span>
                        <span class="angle-value">-Â°</span>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding: 10px; background: #0f172a; border-radius: 6px; font-size: 11px; color: #94a3b8; line-height: 1.4;">
                    <strong style="color: #60a5fa;">ğŸ’¡ ì°¸ê³ :</strong> MVP ë²„ì „ì…ë‹ˆë‹¤. ì‹¤ì œ ì œí’ˆì—ì„œëŠ” RULA, REBA í‘œì¤€ì„ ì ìš©í•©ë‹ˆë‹¤.
                </div>
            </div>
        </div>
    </div>

    <!-- PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸ -->
    <div class="install-prompt" id="installPrompt">
        <div style="flex: 1;">
            <strong>ğŸ“± ì•±ìœ¼ë¡œ ì„¤ì¹˜í•˜ê¸°</strong>
            <div style="font-size: 12px; margin-top: 4px; opacity: 0.9;">í™ˆ í™”ë©´ì— ì¶”ê°€í•˜ë©´ ì•±ì²˜ëŸ¼ ì‚¬ìš©í•  ìˆ˜ ìˆì–´ìš”</div>
        </div>
        <button id="installBtn">ì„¤ì¹˜</button>
        <button class="close" id="closeInstall">Ã—</button>
    </div>

    <script>
        // Service Worker ë“±ë¡
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker ë“±ë¡ë¨'))
                    .catch(err => console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', err));
            });
        }

        // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
        let deferredPrompt;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.add('show');
        });

        document.getElementById('installBtn').addEventListener('click', async () => {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log('ì„¤ì¹˜ ì„ íƒ:', outcome);
            deferredPrompt = null;
            document.getElementById('installPrompt').classList.remove('show');
        });

        document.getElementById('closeInstall').addEventListener('click', () => {
            document.getElementById('installPrompt').classList.remove('show');
        });

        // ë©”ì¸ ì•± ë¡œì§
        let detector = null;
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');
        let statusElement = document.getElementById('status');
        let animationFrameId = null;
        let isRunning = false;

        async function initPoseDetection() {
            try {
                statusElement.textContent = 'ğŸ”„ AI ëª¨ë¸ ë¡œë”© ì¤‘... (ì²« ì‹¤í–‰ì‹œ 1-2ë¶„ ì†Œìš”)';
                
                // TensorFlow.js ë¡œë”© í™•ì¸
                if (typeof poseDetection === 'undefined') {
                    throw new Error('TensorFlow.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }
                
                console.log('TensorFlow.js ë¡œë“œ ì™„ë£Œ');
                
                const model = poseDetection.SupportedModels.MoveNet;
                detector = await poseDetection.createDetector(model, {
                    modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
                });
                
                console.log('Pose detector ì´ˆê¸°í™” ì™„ë£Œ!');
                
                statusElement.textContent = 'âœ… AI ì¤€ë¹„ ì™„ë£Œ! ì¹´ë©”ë¼ë¥¼ ì‹œì‘í•˜ê±°ë‚˜ ì˜ìƒì„ ì—…ë¡œë“œí•˜ì„¸ìš”';
                document.getElementById('startWebcam').disabled = false;
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                statusElement.textContent = 'âŒ ì˜¤ë¥˜: ' + error.message + ' - ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”';
                statusElement.style.background = '#7f1d1d';
            }
        }

        function calculateAngle(a, b, c) {
            const radians = Math.atan2(c.y - b.y, c.x - b.x) - Math.atan2(a.y - b.y, a.x - b.x);
            let angle = Math.abs(radians * 180.0 / Math.PI);
            if (angle > 180.0) {
                angle = 360 - angle;
            }
            return angle;
        }

        async function detectPose() {
            if (!isRunning) return;
            
            // detectorê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ëŒ€ê¸°
            if (!detector) {
                statusElement.textContent = 'âš ï¸ AI ëª¨ë¸ì„ ì•„ì§ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤...';
                animationFrameId = requestAnimationFrame(detectPose);
                return;
            }

            try {
                const poses = await detector.estimatePoses(video);
                
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                if (poses.length > 0) {
                    const pose = poses[0];
                    const keypoints = pose.keypoints;
                    
                    // í‚¤í¬ì¸íŠ¸ ê·¸ë¦¬ê¸°
                    keypoints.forEach(kp => {
                        if (kp.score > 0.3) {
                            ctx.beginPath();
                            ctx.arc(kp.x, kp.y, 5, 0, 2 * Math.PI);
                            ctx.fillStyle = '#FF0000';
                            ctx.fill();
                        }
                    });

                    // ì—°ê²°ì„  ê·¸ë¦¬ê¸°
                    const connections = [
                        [5, 6], [5, 7], [7, 9], [6, 8], [8, 10],
                        [5, 11], [6, 12], [11, 12],
                        [11, 13], [13, 15], [12, 14], [14, 16]
                    ];
                    
                    ctx.strokeStyle = '#00FF00';
                    ctx.lineWidth = 3;
                    connections.forEach(([i, j]) => {
                        const kp1 = keypoints[i];
                        const kp2 = keypoints[j];
                        if (kp1.score > 0.3 && kp2.score > 0.3) {
                            ctx.beginPath();
                            ctx.moveTo(kp1.x, kp1.y);
                            ctx.lineTo(kp2.x, kp2.y);
                            ctx.stroke();
                        }
                    });

                    // ê°ë„ ê³„ì‚°
                    const leftShoulder = keypoints[5];
                    const rightShoulder = keypoints[6];
                    const leftHip = keypoints[11];
                    const rightHip = keypoints[12];
                    const leftElbow = keypoints[7];
                    const rightElbow = keypoints[8];
                    const nose = keypoints[0];

                    let backAngle = 0;
                    let neckAngle = 0;
                    let leftShoulderAngle = 0;
                    let rightShoulderAngle = 0;

                    if (leftShoulder.score > 0.3 && leftHip.score > 0.3) {
                        backAngle = Math.abs(90 - Math.atan2(
                            leftShoulder.y - leftHip.y,
                            leftShoulder.x - leftHip.x
                        ) * 180 / Math.PI);
                    }

                    if (nose.score > 0.3 && leftShoulder.score > 0.3 && rightShoulder.score > 0.3) {
                        const midShoulder = {
                            x: (leftShoulder.x + rightShoulder.x) / 2,
                            y: (leftShoulder.y + rightShoulder.y) / 2
                        };
                        neckAngle = Math.abs(90 - Math.atan2(
                            nose.y - midShoulder.y,
                            nose.x - midShoulder.x
                        ) * 180 / Math.PI);
                    }

                    if (leftShoulder.score > 0.3 && leftElbow.score > 0.3 && leftHip.score > 0.3) {
                        leftShoulderAngle = calculateAngle(leftHip, leftShoulder, leftElbow);
                    }

                    if (rightShoulder.score > 0.3 && rightElbow.score > 0.3 && rightHip.score > 0.3) {
                        rightShoulderAngle = calculateAngle(rightHip, rightShoulder, rightElbow);
                    }

                    // ìœ„í—˜ë„ í‰ê°€
                    let riskLevel = 'low';
                    let riskText = 'ì•ˆì „';
                    let riskDesc = 'ì–‘í˜¸í•œ ìì„¸ì…ë‹ˆë‹¤';
                    
                    if (backAngle > 30 || neckAngle > 40) {
                        riskLevel = 'high';
                        riskText = 'âš ï¸ ìœ„í—˜';
                        riskDesc = 'í—ˆë¦¬/ëª© ê°ë„ ìœ„í—˜';
                    } else if (backAngle > 15 || neckAngle > 25) {
                        riskLevel = 'medium';
                        riskText = 'âš¡ ì£¼ì˜';
                        riskDesc = 'ìì„¸ ê°œì„  í•„ìš”';
                    }

                    // UI ì—…ë°ì´íŠ¸
                    document.getElementById('angleList').innerHTML = `
                        <div class="angle-item">
                            <span>í—ˆë¦¬ êµ½í˜</span>
                            <span class="angle-value">${backAngle.toFixed(1)}Â°</span>
                        </div>
                        <div class="angle-item">
                            <span>ëª© ê¸°ìš¸ê¸°</span>
                            <span class="angle-value">${neckAngle.toFixed(1)}Â°</span>
                        </div>
                        <div class="angle-item">
                            <span>ì–´ê¹¨ (ì¢Œ)</span>
                            <span class="angle-value">${leftShoulderAngle.toFixed(1)}Â°</span>
                        </div>
                        <div class="angle-item">
                            <span>ì–´ê¹¨ (ìš°)</span>
                            <span class="angle-value">${rightShoulderAngle.toFixed(1)}Â°</span>
                        </div>
                    `;

                    const riskElement = document.getElementById('overallRisk');
                    riskElement.className = `metric risk-${riskLevel}`;
                    riskElement.innerHTML = `
                        <div class="metric-label">ì¢…í•© ìœ„í—˜ë„</div>
                        <div class="metric-value">${riskText}</div>
                        <div class="metric-desc">${riskDesc}</div>
                    `;

                    statusElement.textContent = 'âœ… í¬ì¦ˆ ì¸ì‹ ì¤‘...';
                } else {
                    statusElement.textContent = 'âš ï¸ ì‚¬ëŒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                }
            } catch (error) {
                console.error('ê°ì§€ ì˜¤ë¥˜:', error);
            }

            animationFrameId = requestAnimationFrame(detectPose);
        }

        // ì›¹ìº  ì‹œì‘
        document.getElementById('startWebcam').addEventListener('click', async () => {
            if (!detector) {
                alert('AI ëª¨ë¸ì´ ì•„ì§ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                statusElement.textContent = 'ğŸ“¹ ì¹´ë©”ë¼ ì ‘ê·¼ ì¤‘...';
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment', // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                video.srcObject = stream;
                await video.play();
                
                isRunning = true;
                detectPose();
                
                document.getElementById('startWebcam').disabled = true;
                document.getElementById('stopWebcam').disabled = false;
                statusElement.textContent = 'âœ… ì¹´ë©”ë¼ í™œì„±í™”ë¨';
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì˜¤ë¥˜:', error);
                statusElement.textContent = 'âŒ ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨';
                alert('ì¹´ë©”ë¼ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.\n\nì„¤ì • > Safari/Chrome > ì¹´ë©”ë¼ ê¶Œí•œ í™•ì¸');
            }
        });

        // ì›¹ìº  ì •ì§€
        document.getElementById('stopWebcam').addEventListener('click', () => {
            isRunning = false;
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            document.getElementById('startWebcam').disabled = false;
            document.getElementById('stopWebcam').disabled = true;
            statusElement.textContent = 'â¹ï¸ ì¹´ë©”ë¼ ì •ì§€ë¨';
        });

        // ì˜ìƒ ì—…ë¡œë“œ
        document.getElementById('videoFile').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!detector) {
                alert('AI ëª¨ë¸ì´ ì•„ì§ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
                return;
            }

            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }

            const url = URL.createObjectURL(file);
            video.src = url;
            video.loop = true;
            
            video.onloadeddata = () => {
                statusElement.textContent = 'ğŸ“¹ ì˜ìƒ ë¶„ì„ ì¤‘...';
                video.play();
                isRunning = true;
                detectPose();
            };
        });

        window.addEventListener('load', initPoseDetection);
    </script>
</body>
</html>
